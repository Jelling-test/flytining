# =============================================================================
# TELEGRAF CONFIGURATION - JELLING POWER SYSTEM
# =============================================================================
# Samler data fra alle Zigbee2MQTT områder og skriver til Supabase PostgreSQL
# =============================================================================

[agent]
  omit_hostname = true
  interval = "10s"
  flush_interval = "10s"

# =============================================================================
# INPUT: MQTT - Læs fra alle Zigbee2MQTT områder
# =============================================================================
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "zigbee2mqtt/+",
    "zigbee2mqtt_area2/+",
    "zigbee2mqtt_area3/+",
    "zigbee2mqtt_area4/+",
    "zigbee2mqtt_area5/+",
    "zigbee2mqtt_area6/+",
    "zigbee2mqtt_3p/+"
  ]
  qos = 1
  persistent_session = true
  client_id = "telegraf-jelling-power"
  username = "homeassistant"
  password = "7200Grindsted!"
  data_format = "json_v2"
  topic_tag = "topic"
  name_override = "meter_readings"

  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "current"
      type = "float"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "energy"
      type = "float"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "power"
      type = "float"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "voltage"
      type = "float"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "linkquality"
      type = "int"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state"
      type = "string"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "indicator_mode"
      type = "string"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "power_outage_memory"
      type = "string"
      optional = true
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "update.installed_version"
      type = "int"
      optional = true
      rename = "update_installed_version"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "update.latest_version"
      type = "int"
      optional = true
      rename = "update_latest_version"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "availability"
      type = "string"
      optional = true
      rename = "is_available"

# =============================================================================
# PROCESSOR: Udtræk meter_id fra topic
# =============================================================================
[[processors.regex]]
  namepass = ["meter_readings"]
  [[processors.regex.tags]]
    key = "topic"
    pattern = ".*/([^/]+)$"
    replacement = "${1}"
    result_key = "meter_id"

# =============================================================================
# OUTPUT: Supabase PostgreSQL
# =============================================================================
[[outputs.postgresql]]
  connection = "host=db.jkmqliztlhmfyejhmuil.supabase.co port=5432 user=postgres password=7200Grindsted! dbname=postgres sslmode=require"
  tagexclude = ["topic"]
